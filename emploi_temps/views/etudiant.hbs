<h2>Voir l'emploi du temps d'un étudiant</h2>
{{#if error}}<p style="color:darkred">{{error}}</p>{{/if}}
<form id="studentForm">
  <label>Choisir étudiant :</label>
  <select id="studentSelect" name="studentId">
    <option value="">-- Sélectionner --</option>
    {{#each students}}
      <option value="{{id}}">{{nom}}</option>
    {{/each}}
  </select>
  <button type="button" id="viewBtn" class="btn">Voir</button>
</form>

<div id="calendar"></div>
<div id="etudiantStatus" style="margin:10px 0;color:var(--muted)"></div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<script>
  let calendar;
  function showStatus(msg, isError) {
    const s = document.getElementById('etudiantStatus');
    s.textContent = msg || '';
    s.style.color = isError ? 'darkred' : 'var(--muted)';
  }

  function renderList(events) {
    const containerId = 'etudiantCoursesList';
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.style.marginTop = '14px';
      document.querySelector('.card').appendChild(container);
    }
    container.innerHTML = '';
    if (!events || events.length === 0) {
      container.innerHTML = `<p>Aucun cours trouvé pour cet étudiant.</p>`;
      return;
    }
    let html = '<h3>Liste des cours</h3>';
    html += '<table style="width:100%;border-collapse:collapse"><thead><tr><th>Titre</th><th>Début</th><th>Fin</th><th>Salle</th></tr></thead><tbody>';
    events.forEach(ev => {
      const start = new Date(ev.start).toLocaleString();
      const end = new Date(ev.end).toLocaleString();
      html += `<tr><td>${ev.title}</td><td>${start}</td><td>${end}</td><td>${ev.extendedProps && ev.extendedProps.salle ? ev.extendedProps.salle : ''}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      headerToolbar: { left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay,dayGridMonth' },
      slotMinTime: '07:00:00', slotMaxTime: '20:00:00',
      events: []
    });
    calendar.render();

    document.getElementById('viewBtn').addEventListener('click', () => {
      const sid = document.getElementById('studentSelect').value;
      if (!sid) return showStatus('Veuillez sélectionner un étudiant.', true);
      showStatus('Chargement…');
      calendar.removeAllEvents();
      fetch('/api/cours?studentId=' + encodeURIComponent(sid)).then(r => {
        if (!r.ok) throw new Error('Réponse serveur: ' + r.status);
        return r.json();
      }).then(events => {
        if (!events || events.length === 0) {
          showStatus('Aucun cours trouvé pour cet étudiant.');
        } else {
          showStatus('');
        }
        calendar.addEventSource(events || []);
        renderList(events || []);
      }).catch(err => {
        console.error(err);
        showStatus('Erreur lors du chargement des cours. Vérifiez la connexion au serveur.', true);
      });
    });

    // Auto-select based on server-provided selectedId
    const select = document.getElementById('studentSelect');
    const serverSelected = {{#if selectedId}}{{selectedId}}{{else}}null{{/if}};
    if (select && serverSelected) {
      select.value = serverSelected;
      // trigger load automatically
      document.getElementById('viewBtn').click();
    } else if (select && select.options.length === 2) { // fallback: if only one student, select it
      select.selectedIndex = 1;
    }
  });
</script>