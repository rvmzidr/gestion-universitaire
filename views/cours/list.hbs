<div class="page-header">
    <h1>{{title}}</h1>
    {{#if canCreateCourse}}
    <div style="display: flex; gap: 10px;">
        <a href="/cours/create" class="btn btn-primary">+ Planifier un cours</a>
    </div>
    {{/if}}
</div>

{{#if success}}
    <div class="alert alert-success">
        {{#if (eq success 'create')}}Cours planifi√© avec succ√®s.{{/if}}
        {{#if (eq success 'update')}}Cours mis √† jour avec succ√®s.{{/if}}
        {{#if (eq success 'delete')}}Cours supprim√© avec succ√®s.{{/if}}
    </div>
{{/if}}

{{#if error}}
    <div class="alert alert-error">Une erreur est survenue. Veuillez r√©essayer.</div>
{{/if}}

{{#if infoMessage}}
    <div class="alert alert-info">{{infoMessage}}</div>
{{/if}}

<div class="info-card" style="margin-bottom: var(--spacing-xl);">
    <h3>üìö Vue d'ensemble</h3>
    <p>Consultez et g√©rez les cours programm√©s. Les conflits d'horaires sont emp√™ch√©s automatiquement lors de la cr√©ation et de la modification.</p>
</div>

{{#if missingDepartement}}
<div class="alert alert-warning">
    Aucun d√©partement n'est associ√© √† votre compte directeur. Contactez un administrateur pour acc√©der aux cours de votre d√©partement.
</div>
{{/if}}

{{#if (or isAdmin isDirector)}}
<div class="filter-card" style="margin-bottom: var(--spacing-xl);">
    <h3>üîç Filtrer les cours</h3>
    <form method="GET" action="/cours" id="filterCoursForm">
        <div class="filter-grid">
            {{#if isAdmin}}
            <div class="form-group">
                <label for="id_departement">D√©partement</label>
                <select id="id_departement" name="id_departement" class="form-control">
                    <option value="">Tous les d√©partements</option>
                    {{#each departements}}
                        <option value="{{this.id}}" {{#if (eq this.id ../selectedDeptId)}}selected{{/if}}>
                            {{this.nom}} ({{this.code}})
                        </option>
                    {{/each}}
                </select>
            </div>
            {{/if}}
            
            <div class="form-group">
                <label for="id_enseignant">Enseignant</label>
                <select id="id_enseignant" name="id_enseignant" class="form-control">
                    <option value="">Tous les enseignants</option>
                    {{#each enseignants}}
                        <option value="{{this.id}}" data-departement="{{this.id_departement}}" {{#if (eq this.id ../selectedEnseignantId)}}selected{{/if}}>
                            {{this.prenom}} {{this.nom}}
                        </option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="id_groupe">Groupe</label>
                <select id="id_groupe" name="id_groupe" class="form-control">
                    <option value="">Tous les groupes</option>
                    {{#each groupes}}
                        <option value="{{this.id}}" data-departement="{{this.id_departement}}" {{#if (eq this.id ../selectedGroupeId)}}selected{{/if}}>
                            {{this.nom}}
                        </option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="type_cours">Type de cours</label>
                <select id="type_cours" name="type_cours" class="form-control">
                    <option value="">Tous les types</option>
                    {{#each typeOptions}}
                        <option value="{{this.value}}" {{#if (eq this.value ../selectedType)}}selected{{/if}}>
                            {{this.label}}
                        </option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="jour">Jour</label>
                <select id="jour" name="jour" class="form-control">
                    <option value="">Tous les jours</option>
                    {{#each dayOptions}}
                        <option value="{{this.value}}" {{#if (eq this.value ../selectedJour)}}selected{{/if}}>
                            {{this.label}}
                        </option>
                    {{/each}}
                </select>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button type="submit" class="btn btn-primary">üîç Filtrer</button>
            <a href="/cours" class="btn btn-secondary">üîÑ R√©initialiser</a>
        </div>
    </form>
</div>

<script>
{{#if isAdmin}}
// Filtrage dynamique des enseignants et groupes par d√©partement
document.getElementById('id_departement').addEventListener('change', function() {
    const selectedDeptId = this.value;
    const enseignantSelect = document.getElementById('id_enseignant');
    const groupeSelect = document.getElementById('id_groupe');
    
    // Filtrer les enseignants
    const enseignantOptions = enseignantSelect.querySelectorAll('option');
    enseignantOptions.forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        const optionDept = option.getAttribute('data-departement');
        if (!selectedDeptId || optionDept === selectedDeptId) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            if (option.selected) {
                enseignantSelect.value = '';
            }
        }
    });
    
    // Filtrer les groupes
    const groupeOptions = groupeSelect.querySelectorAll('option');
    groupeOptions.forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        const optionDept = option.getAttribute('data-departement');
        if (!selectedDeptId || optionDept === selectedDeptId) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            if (option.selected) {
                groupeSelect.value = '';
            }
        }
    });
});

// Appliquer le filtre au chargement si un d√©partement est d√©j√† s√©lectionn√©
if (document.getElementById('id_departement').value) {
    document.getElementById('id_departement').dispatchEvent(new Event('change'));
}
{{/if}}
</script>
{{/if}}

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Titre</th>
                <th>Type</th>
                <th>Enseignant</th>
                <th>Groupe</th>
                <th>Sp√©cialit√©</th>
                <th>D√©partement</th>
                <th>Salle</th>
                <th>Jour</th>
                <th>Horaire</th>
                {{#if showActionsColumn}}
                <th>Actions</th>
                {{/if}}
            </tr>
        </thead>
        <tbody>
            {{#each cours}}
                <tr>
                    <td>
                        <strong>{{this.titre}}</strong>
                        {{#if this.description}}
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">{{this.description}}</div>
                        {{/if}}
                    </td>
                    <td><span class="badge badge-primary">{{this.type_label}}</span></td>
                    <td>
                        {{#if this.enseignant_nom}}
                            {{this.enseignant_prenom}} {{this.enseignant_nom}}
                        {{else}}
                            <span style="color: var(--text-muted);">√Ä affecter</span>
                        {{/if}}
                    </td>
                    <td>{{#if this.groupe_nom}}{{this.groupe_nom}}{{else}}<span style="color: var(--text-muted);">√Ä affecter</span>{{/if}}</td>
                    <td>{{this.specialite_label}}</td>
                    <td>{{this.departement_label}}</td>
                    <td>{{#if this.salle_nom}}{{this.salle_nom}}{{else if this.salle_code}}{{this.salle_code}}{{else}}<span style="color: var(--text-muted);">√Ä affecter</span>{{/if}}</td>
                    <td>{{this.jour_label}}</td>
                    <td>{{this.heure_debut_affiche}} - {{this.heure_fin_affiche}}</td>
                    {{#if ../showActionsColumn}}
                    <td class="actions">
                        {{#if this.canManage}}
                            <a href="/cours/edit/{{this.id}}" class="btn btn-sm btn-edit">Modifier</a>
                            <form action="/cours/delete/{{this.id}}" method="POST" style="display: inline;" onsubmit="return confirm('Confirmez-vous la suppression de ce cours ?');">
                                <button type="submit" class="btn btn-sm btn-delete">Supprimer</button>
                            </form>
                        {{else}}
                            <span style="color: var(--text-muted);">Non autoris√©</span>
                        {{/if}}
                    </td>
                    {{/if}}
                </tr>
            {{else}}
                <tr>
                    <td colspan="{{#if showActionsColumn}}10{{else}}9{{/if}}" class="text-center">Aucun cours planifi√© pour le moment.</td>
                </tr>
            {{/each}}
        </tbody>
    </table>
</div>
