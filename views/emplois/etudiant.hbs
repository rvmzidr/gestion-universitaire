<div class="page-header">
    <h1>Mon emploi du temps</h1>
    <div style="display: flex; gap: 10px;">
        <span class="badge badge-primary">Ann√©e universitaire 2025 - 2026</span>
    </div>
</div>

{{#if missingProfile}}
    <div class="info-card">
        <h3>Profil √©tudiant incomplet</h3>
        <p>Nous n'avons pas trouv√© de fiche √©tudiant associ√©e √† votre compte. Merci de contacter l'administration pour finaliser votre inscription.</p>
    </div>
{{else if missingGroup}}
    <div class="info-card">
        <h3>Groupe non d√©fini</h3>
        <p>Votre fiche √©tudiante ne contient pas encore d'affectation √† un groupe. Veuillez contacter le service scolarit√©.</p>
    </div>
{{else}}
    <div class="info-card" style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
        <div>
            <h3>{{student.prenom}} {{student.nom}}</h3>
            <p style="margin-top: 5px; color: var(--text-secondary);">
                Groupe : <strong>{{groupe.nom}}</strong>
                {{#if student.specialite_nom}}
                    ‚Ä¢ Sp√©cialit√© : <strong>{{student.specialite_nom}}</strong>
                {{/if}}
            </p>
        </div>
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <span class="badge badge-success">Semestre courant</span>
            {{#if hasCours}}
                <span class="badge badge-info">{{activeDayCount}} jour{{#if (eq activeDayCount 1)}}{{else}}s{{/if}} planifi√©{{#if (eq activeDayCount 1)}}{{else}}s{{/if}}</span>
            {{/if}}
        </div>
    </div>

    {{#unless hasCours}}
        <div class="info-card" style="border-left-color: var(--warning-color);">
            <h3>Aucun cours planifi√©</h3>
            <p>Votre emploi du temps n'a pas encore √©t√© publi√©. Revenez plus tard ou contactez votre responsable de formation.</p>
        </div>
    {{/unless}}

    {{#if hasCours}}
        <div class="calendar-wrapper">
            <div class="calendar-time-column">
                {{#each timeScale}}
                    <div class="calendar-time-slot">{{this}}</div>
                {{/each}}
            </div>
            <div class="calendar-days">
                {{#each schedule}}
                    <div class="calendar-day">
                        <div class="calendar-day-header">{{this.label}}</div>
                        <div class="calendar-day-body" style="height: {{../calendarHeight}}px;">
                            {{#each this.sessions}}
                                <div class="calendar-event" style="top: {{this.position.top}}px; height: {{this.position.height}}px;">
                                    <span class="calendar-event-time">{{this.heure_debut_affiche}} - {{this.heure_fin_affiche}}</span>
                                    <strong class="calendar-event-title">{{this.titre}}</strong>
                                    <span class="calendar-event-meta">{{this.type_label}}</span>
                                    <span class="calendar-event-detail">üë®‚Äçüè´ {{this.enseignant_affichage}}</span>
                                    <span class="calendar-event-detail">üè´ {{this.salle_affichage}}</span>
                                </div>
                            {{/each}}
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    {{/if}}
{{/if}}

    {{#if groupe}}
    <div style="margin-top:20px;">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
            <button id="toggle-interactive" class="btn btn-secondary">Basculer en mode interactif</button>
            <small style="color:var(--text-secondary);">Mode interactif utilise FullCalendar (CDN)</small>
        </div>

        <div id="fc-root" style="display:none;">
            <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
            <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

            <div id="fc-calendar" style="background:#fff;padding:10px;border-radius:6px;border:1px solid var(--card-border);"></div>
        </div>

        <script>
            // inject groupe id for client script; guard in case groupe is undefined
            window.__GROUPE_ID__ = {{groupe.id}};
            document.getElementById('toggle-interactive').addEventListener('click', function () {
                const root = document.getElementById('fc-root');
                const wrapper = document.querySelector('.calendar-wrapper');
                if (root.style.display === 'none') {
                    root.style.display = 'block';
                    wrapper && (wrapper.style.display = 'none');
                } else {
                    root.style.display = 'none';
                    wrapper && (wrapper.style.display = 'flex');
                }
            });
        </script>

        <script src="/js/emplois-calendar.js"></script>
    </div>
    {{else}}
    <div style="margin-top:20px;">
        <div class="info-card">
            <h3>Groupe introuvable</h3>
            <p>Votre compte n'est pas encore rattach√© √† un groupe. Le mode interactif n√©cessite une affectation de groupe pour afficher votre emploi du temps.</p>
        </div>
    </div>
    {{/if}}

