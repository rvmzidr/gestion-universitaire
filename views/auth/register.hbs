<div class="auth-container">
    <div class="auth-box">
        <h2>Inscription</h2>
        
        {{#if error}}
        <div class="alert alert-error">{{error}}</div>
        {{/if}}

        <form action="/auth/register" method="POST">
            <div class="form-group">
                <label for="nom">Nom :</label>
                <input type="text" id="nom" name="nom" value="{{formData.nom}}" required>
            </div>

            <div class="form-group">
                <label for="prenom">Prénom :</label>
                <input type="text" id="prenom" name="prenom" value="{{formData.prenom}}" required>
            </div>

            <div class="form-group">
                <label for="email">Email :</label>
                <input type="email" id="email" name="email" value="{{formData.email}}" required>
            </div>

            <div class="form-group">
                <label for="login">Login :</label>
                <input type="text" id="login" name="login" value="{{formData.login}}" required>
            </div>

            <div class="form-group">
                <label for="password">Mot de passe :</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div class="form-group">
                <label for="role">Rôle :</label>
                <select id="role" name="role" required>
                    <option value="etudiant" {{#if (eq formData.role 'etudiant')}}selected{{/if}}>Étudiant</option>
                    <option value="enseignant" {{#if (eq formData.role 'enseignant')}}selected{{/if}}>Enseignant</option>
                    <option value="directeur" {{#if (eq formData.role 'directeur')}}selected{{/if}}>Directeur</option>
                    {{#if isAdmin}}
                    <option value="admin" {{#if (eq formData.role 'admin')}}selected{{/if}}>Administrateur</option>
                    {{/if}}
                </select>
            </div>

            <div class="form-group" id="departement-field" {{#unless showDepartementField}}style="display: none;"{{/unless}}>
                <label for="id_departement">Département :</label>
                <select id="id_departement" name="id_departement">
                    <option value="">Sélectionnez un département</option>
                    {{#each departements}}
                    <option value="{{this.id}}" {{#if (eq ../formData.id_departement this.id)}}selected{{/if}}>{{this.nom}}</option>
                    {{/each}}
                </select>
            </div>

            <!-- Champ téléphone pour enseignant uniquement -->
            <div class="form-group" id="telephone-field" style="display: none;">
                <label for="telephone">Téléphone (optionnel) :</label>
                <input type="tel" id="telephone" name="telephone" value="{{formData.telephone}}" autocomplete="off">
            </div>

            <!-- Champs spécifiques pour étudiant -->
            <div id="etudiant-fields" style="display: none;">
                <div class="form-group">
                    <label for="cin">CIN (optionnel) :</label>
                    <input type="text" id="cin" name="cin" value="{{formData.cin}}">
                    <small>Sera généré automatiquement si non renseigné</small>
                </div>
                
                <div class="form-group">
                    <label for="date_naissance">Date de naissance :</label>
                    <input type="date" id="date_naissance" name="date_naissance" value="{{formData.date_naissance}}">
                </div>
                
                <div class="form-group">
                    <label for="id_specialite">Spécialité :</label>
                    <select id="id_specialite" name="id_specialite">
                        <option value="">Sélectionnez une spécialité</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="id_groupe">Groupe :</label>
                    <select id="id_groupe" name="id_groupe">
                        <option value="">Sélectionnez d'abord une spécialité</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">S'inscrire</button>
        </form>

        <p class="text-center">
            Déjà inscrit ? <a href="/auth/login">Se connecter</a>
        </p>
    </div>
</div>

<script>
    (function () {
        const roleSelect = document.getElementById('role');
        const departementField = document.getElementById('departement-field');
        const departementSelect = document.getElementById('id_departement');
        const telephoneField = document.getElementById('telephone-field');
        const etudiantFields = document.getElementById('etudiant-fields');
        const specialiteSelect = document.getElementById('id_specialite');
        const groupeSelect = document.getElementById('id_groupe');

        // Charger les spécialités par département
        async function loadSpecialites(departementId) {
            if (!departementId || !specialiteSelect) return;
            
            try {
                const response = await fetch(`/api/specialites?id_departement=${departementId}`);
                const specialites = await response.json();
                
                specialiteSelect.innerHTML = '<option value="">Sélectionnez une spécialité</option>';
                specialites.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.nom;
                    specialiteSelect.appendChild(option);
                });
                
                groupeSelect.innerHTML = '<option value="">Sélectionnez d\'abord une spécialité</option>';
            } catch (error) {
                console.error('Erreur lors du chargement des spécialités:', error);
            }
        }

        // Charger les groupes par spécialité
        async function loadGroupes(specialiteId) {
            if (!specialiteId || !groupeSelect) return;
            
            try {
                const response = await fetch(`/api/groupes?id_specialite=${specialiteId}`);
                const groupes = await response.json();
                
                groupeSelect.innerHTML = '<option value="">Sélectionnez un groupe</option>';
                groupes.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.textContent = g.nom;
                    groupeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des groupes:', error);
            }
        }

        const toggleFields = () => {
            if (!roleSelect) return;
            
            const role = roleSelect.value;
            const rolesWithDepartement = ['etudiant', 'enseignant', 'directeur'];
            
            // Département
            const showDept = rolesWithDepartement.includes(role);
            if (departementField) {
                departementField.style.display = showDept ? 'block' : 'none';
                const select = departementField.querySelector('select');
                if (select) {
                    select.required = showDept;
                    if (!showDept) select.value = '';
                }
            }
            
            // Téléphone (uniquement pour enseignant)
            if (telephoneField) {
                telephoneField.style.display = role === 'enseignant' ? 'block' : 'none';
            }
            
            // Champs étudiant
            if (etudiantFields) {
                etudiantFields.style.display = role === 'etudiant' ? 'block' : 'none';
            }
        };

        if (roleSelect) {
            roleSelect.addEventListener('change', toggleFields);
            toggleFields();
        }

        // Événements pour charger spécialités et groupes
        if (departementSelect) {
            departementSelect.addEventListener('change', (e) => {
                if (roleSelect.value === 'etudiant') {
                    loadSpecialites(e.target.value);
                }
            });
        }

        if (specialiteSelect) {
            specialiteSelect.addEventListener('change', (e) => {
                loadGroupes(e.target.value);
            });
        }
    })();
</script>